<script>
    window.addEventListener("load", () => {
        gsap.registerPlugin(ScrollTrigger, MotionPathPlugin);

        let isMobile = window.matchMedia("(max-width: 768px)").matches;

        let scrollSectionPinTopValue = 'top';
        if (isMobile) {
            scrollSectionPinTopValue = `top-=${(document.querySelector(".scroll-section").getBoundingClientRect().top)}`;
            initAnimationMobile();
        } else {
            initAnimationWeb();
        }

        function initAnimationMobile() {
            let maxScrollY = document.documentElement.scrollHeight - window.innerHeight;            

            ScrollTrigger.config({ viewport: "mobile" }); // Essential for mobile stability            
            let scrollSectionHeight = document.querySelector(".scroll-section").offsetHeight;
            // console.log(scrollSectionHeight);
            let marketingSectionHeight = document.querySelector(".marketing-section").offsetHeight;
            // console.log(marketingSectionHeight);
            // alert(scrollSectionHeight.toString() + ' ' + marketingSectionHeight.toString() + ' ' + isMobile.toString());


            let boxes = gsap.utils.toArray('.marketing-box-1, .marketing-box-2, .marketing-box-3');
            gsap.set(boxes, {
                x: window.innerWidth,
            });
            let defaultPositionOfMarketingSection = document.querySelector(".marketing-section").getBoundingClientRect().top;
            let tl = gsap.timeline({
                scrollTrigger: {
                    trigger: ".scroll-section",
                    start: `${scrollSectionPinTopValue} top`,
                    end: `${maxScrollY-(document.querySelector('.theory-section-mobile').offsetHeight+document.querySelector('.main-footer').offsetHeight)}`,
                    scrub: true,
                    pin: true,
                    pinSpacing: false,
                    anticipatePin: 1,
                    onLeave: () => {
                    },
                    onEnter: () => {

                    },
                    onUpdate: (e) => {
                        // console.log('update', e);
                    }
                }
            });

            // 1. --- PHASE 1: Caption Animations (0.0s to 1.0s) ---
            // Start Caption 1 set at 0.0s. It will run until 0.5s.
            tl.to(".logo", { opacity: 0, ease: "power4.out", duration: 0.2 }, 0);
            tl.to(".text-caption-wrapper", { x: 10, width: "100%", ease: "power2.out", duration: 0.5 }, 0);
            tl.to(".text-caption-wrapper .text-caption", { x: 0, color: '#EC4D20', ease: "power3.out", duration: 0.7 }, 0.2);

            // Start Caption 2 set at 0.5s. It must finish by 1.0s.
            // NOTE: We don't use 'caption2Start' label anymore for simplicity.
            tl.to(".text-caption-wrapper-2", { x: 10, width: "100%", ease: "power2.out", duration: 0.5 }, '>');
            tl.to(".text-caption-wrapper-2 .text-caption-2", { x: 0, color: '#EC4D20', ease: "power3.out", duration: 0.7 }, '<0.2');


            tl.to(".marketing-section", {
                // y: '-' + defaultPositionOfMarketingSection.toString()
                y: `-${document.querySelector('.scroll-section-main-grid').offsetHeight + 20}`,
                duration: 2
            }, '>');

            tl.to(boxes, {
                x: 0,
                stagger: 0.5,
            });

            // // let st = tl.scrollTrigger;
            // // st.end = "+=" + (tl.duration() * 500); // 500px per second of timeline
            // // st.refresh();

            // // Refresh listener (Keep this)
            // ScrollTrigger.addEventListener("refresh", () => {
            //     // ... recalculate heights
            // });
        }

        function initAnimationWeb() {
            let scrollSectionHeight = document.querySelector(".scroll-section-web").offsetHeight;
            // console.log(scrollSectionHeight);
            let marketingSectionHeight = document.querySelector(".marketing-section-web").offsetHeight;
            // console.log(marketingSectionHeight);
            // alert(scrollSectionHeight.toString() + ' ' + marketingSectionHeight.toString() + ' ' + isMobile.toString());
            gsap.to('.scroll-section-web', {
                scrollTrigger: {
                    trigger: ".scroll-section-web",
                    start: () => `top top`,
                    end: () => `+=${scrollSectionHeight + marketingSectionHeight}`,
                    scrub: true,
                    pin: true,
                    pinSpacing: false,
                    anticipatePin: 1
                }
            });

            const tl = gsap.timeline({
                scrollTrigger: {
                    trigger: ".scroll-section-web",
                    start: "0",
                    end: "450",
                    scrub: true,
                    pin: false,
                    pinSpacing: false,
                    anticipatePin: 1
                }
            });

            // Fade out logo
            tl.to(".logo-web", {
                opacity: 0,
                ease: "power4.out",
                duration: 0.2,
            }, 0);

            // First wrapper animations
            tl.to(".text-caption-wrapper-web", {
                x: 10,
                duration: 0.5,
                ease: "power2.out"
            }, 0);

            tl.to(".text-caption-wrapper-web", {
                width: "100%",
                duration: 0.5,
                ease: "power2.inOut"
            }, 0);

            tl.to(".text-caption-wrapper-web .text-caption-web", {
                x: 0,
                duration: 0.1,
                color: '#EC4D20',
                ease: "power3.out",
            }, 0.2);

            // ðŸ•’ Now the second set starts AFTER all above are complete
            tl.to(".text-caption-wrapper-2-web", {
                x: 10,
                duration: 0.5,
                ease: "power2.out"
            }, '>');

            tl.to(".text-caption-wrapper-2-web", {
                width: "100%",
                duration: 0.5,
                ease: "power2.inOut"
            }, '<');

            tl.to(".text-caption-wrapper-2-web .text-caption-2-web", {
                x: 0,
                color: '#EC4D20',
                duration: 0.1,
                ease: "power3.out",
            }, '<0.2');

            // 2ï¸âƒ£ Trigger for animation-section overlapping
            let boxes = gsap.utils.toArray('.marketing-box-1-web, .marketing-box-2-web, .marketing-box-3-web');
            // console.log(boxes);
            // Define path coordinates dynamically
            // Note: x:0, y:0 is now the FINAL destination
            const pathCoordinates = [
                { x: 0, y: 0 },
                { x: window.innerWidth / 2, y: window.innerHeight / 6 },
                { x: window.innerWidth + 100, y: window.innerHeight }
            ];
            // 1. **CRITICAL FIX: Use gsap.set() to override Elementor's initial transforms.**
            // This instantly moves all boxes to the desired final resting position (x:0, y:0)
            // and removes Elementor's initial transform offset.
            gsap.set(boxes, {
                x: 0, // Reset Elementor's horizontal transform
                y: 0, // Reset Elementor's vertical transform
                // We use the first coordinate of the path for the instant placement.
                // motionPath: {
                //     path: pathCoordinates,
                //     alignOrigin: [0.5, 0.5],
                //     start: 0, // Set to the final destination point (progress 0)
                // }
            });
            // 1. **Apply the animation to ALL boxes using stagger**
            const slideInAnimation = gsap.from(boxes, { // <-- Use .from()
                ease: "power2.out",
                stagger: 0.15, // Stagger the start of each box
                motionPath: {
                    path: pathCoordinates,
                    // alignOrigin will make the box center follow the path
                    alignOrigin: [0.5, 0.5],
                    start: 0, // Start at the end of the path (off-screen)
                    end: 1    // Animate TO the start of the path (on-screen, 0,0)
                }
            });
            gsap.to('.marketing-section-web', {
                scrollTrigger: {
                    trigger: ".marketing-section-web",
                    start: `0`,
                    end: `${document.querySelector('.marketing-section-web').getBoundingClientRect().top}`, // scroll distance for overlap
                    scrub: true,
                    pinSpacing: false,
                    pin: true // no pin here
                }
            });
            // 2. **ATTACH SCROLLTRIGGER**
            ScrollTrigger.create({
                trigger: ".marketing-section-web",
                start: "top top",
                end: `+=${marketingSectionHeight + 20}`,
                scrub: true,
                pin: true,
                animation: slideInAnimation,
                markers: false,
            });
            gsap.to('.remaining-section', {
                scrollTrigger: {
                    trigger: ".remaining-section",
                    start: `0`,
                    end: `${document.querySelector('.remaining-section').getBoundingClientRect().top - 20}`, // scroll distance for overlap
                    scrub: false,
                    pinSpacing: false,
                    pin: true // no pin here
                }
            });
        }

    });
</script>