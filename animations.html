<script>
    window.addEventListener("load", () => {
        gsap.registerPlugin(ScrollTrigger, MotionPathPlugin);

        let isMobile = window.matchMedia("(max-width: 768px)").matches;

        let scrollSectionHeight = document.querySelector(".scroll-section").offsetHeight;
        // console.log(scrollSectionHeight);
        let marketingSectionHeight = document.querySelector(".marketing-section").offsetHeight;
        // console.log(marketingSectionHeight);
        // alert(scrollSectionHeight.toString() + ' ' + marketingSectionHeight.toString() + ' ' + isMobile.toString());

        let scrollSectionPinTopValue = 'top';
        if (isMobile) {
            scrollSectionPinTopValue = `top-=${(document.querySelector(".scroll-section").getBoundingClientRect().top)}`;
            initAnimationMobile();
        } else {
            initAnimationWeb();
        }

        function initAnimationMobile() {
            let boxes = gsap.utils.toArray('.marketing-box-1, .marketing-box-2, .marketing-box-3');
            gsap.set(boxes, {
                x: window.innerWidth,
            });
            ScrollTrigger.config({ viewport: "mobile" }); // Essential for mobile stability            
            let defaultPositionOfMarketingSection = document.querySelector(".marketing-section").getBoundingClientRect().top;
            console.logi
            let tl = gsap.timeline({
                scrollTrigger: {
                    trigger: ".scroll-section",
                    start: `${scrollSectionPinTopValue} top`,
                    end: `+=${scrollSectionHeight + 1000}`,
                    scrub: true,
                    pin: true,
                    pinSpacing: true,
                    anticipatePin: 1,
                    onLeave: () => {
                        console.log('scroll trigger end for section .scroll-section');
                    },
                    onEnter: () => {
                        // console.log('marketing section pin start', ', marketing-section position : ', document.querySelector(".marketing-section").getBoundingClientRect().top);
                        // ScrollTrigger.create({
                        //     trigger: '.marketing-section',
                        //     pin: true,
                        //     pinSpacing: false,
                        //     start: 'top ' + defaultPositionOfMarketingSection,
                        //     end: '+=1084',
                        //     anticipate: 1,
                        //     onEnter: () => {
                        //         console.log('marketing section pin start')
                        //     },
                        //     onLeave: () => {
                        //         console.log('marketing section pin end')
                        //     }
                        // });
                    },
                    onUpdate: (e) => {
                        // console.log('update', e);
                    }
                }
            });

            // 1. --- PHASE 1: Caption Animations (0.0s to 1.0s) ---
            // Start Caption 1 set at 0.0s. It will run until 0.5s.
            tl.to(".logo", { opacity: 0, ease: "power4.out", duration: 0.2 }, 0);
            tl.to(".text-caption-wrapper", { x: 10, width: "100%", ease: "power2.out", duration: 0.5 }, 0);
            tl.to(".text-caption-wrapper .text-caption", { x: 0, color: '#EC4D20', ease: "power3.out", duration: 0.7 }, 0.2);

            // Start Caption 2 set at 0.5s. It must finish by 1.0s.
            // NOTE: We don't use 'caption2Start' label anymore for simplicity.
            tl.to(".text-caption-wrapper-2", { x: 10, width: "100%", ease: "power2.out", duration: 0.5 }, '>');
            tl.to(".text-caption-wrapper-2 .text-caption-2", { x: 0, color: '#EC4D20', ease: "power3.out", duration: 0.7 }, '<0.2');


            tl.to(".marketing-section", {
                // y: '-' + defaultPositionOfMarketingSection.toString()
                y: `-${document.querySelector('.scroll-section-main-grid').offsetHeight + 20}`,
                duration: 2
            }, '>');

            tl.to(boxes, {
                x: 0,
                stagger: 0.5,
            });

            // let st = tl.scrollTrigger;
            // st.end = "+=" + (tl.duration() * 500); // 500px per second of timeline
            // st.refresh();

            // Refresh listener (Keep this)
            ScrollTrigger.addEventListener("refresh", () => {
                // ... recalculate heights
            });
        }

        function initAnimationWeb() {
            let totalPinEnd = document.querySelector('.scroll-section-main-grid').offsetHeight + marketingSectionHeight;
            console.log(totalPinEnd);
            const tl = gsap.timeline({
                scrollTrigger: {
                    trigger: ".scroll-section-main-grid",
                    start: () => `${scrollSectionPinTopValue} top`,
                    end: () => `${totalPinEnd}`,
                    scrub: true,
                    pin: true,
                    pinSpacing: false,
                    anticipatePin: 1
                }
            });

            // Fade out logo
            tl.to(".logo", {
                opacity: 0,
                ease: "power4.out",
                duration: 0.1,
            }, 0);

            // // First wrapper animations
            tl.to(".text-caption-wrapper", {
                x: 10,
                duration: 0.5,
                ease: "power2.out"
            }, 0);

            tl.to(".text-caption-wrapper", {
                width: "100%",
                duration: 0.5,
                ease: "power2.inOut"
            }, 0);

            tl.to(".text-caption-wrapper .text-caption", {
                x: 0,
                duration: 0.1,
                color: '#EC4D20',
                ease: "power3.out",
            }, 0.2);

            // ðŸ•’ Now the second set starts AFTER all above are complete
            tl.to(".text-caption-wrapper-2", {
                x: 10,
                duration: 0.5,
                ease: "power2.out"
            }, '>');

            tl.to(".text-caption-wrapper-2", {
                width: "100%",
                duration: 0.5,
                ease: "power2.inOut"
            }, '<');

            tl.to(".text-caption-wrapper-2 .text-caption-2", {
                x: 0,
                color: '#EC4D20',
                duration: 0.1,
                ease: "power3.out",
            }, '<0.2');


            // 2ï¸âƒ£ Trigger for animation-section overlapping
            let boxes = gsap.utils.toArray('.marketing-box-1, .marketing-box-2, .marketing-box-3');
            // console.log(boxes);
            // Define path coordinates dynamically
            // Note: x:0, y:0 is now the FINAL destination
            const pathCoordinates = [
                { x: 0, y: 0 },
                { x: window.innerWidth / 2, y: window.innerHeight / 6 },
                { x: window.innerWidth + 100, y: window.innerHeight }
            ];
            // 1. **CRITICAL FIX: Use gsap.set() to override Elementor's initial transforms.**
            // This instantly moves all boxes to the desired final resting position (x:0, y:0)
            // and removes Elementor's initial transform offset.
            gsap.set(boxes, {
                x: 0, // Reset Elementor's horizontal transform
                y: 0, // Reset Elementor's vertical transform
                // We use the first coordinate of the path for the instant placement.
                // motionPath: {
                //     path: pathCoordinates,
                //     alignOrigin: [0.5, 0.5],
                //     start: 0, // Set to the final destination point (progress 0)
                // }
            });
            // tl.to(".marketing-section", {
            //     // y: '-' + defaultPositionOfMarketingSection.toString()
            //     y: `-${document.querySelector('.scroll-section-main-grid').offsetHeight + 20}`,
            //     duration: 2
            // }, '>');
            // 1. **Apply the animation to ALL boxes using stagger**
            const slideInAnimation = gsap.from(boxes, { // <-- Use .from()
                ease: "power2.out",
                stagger: 0.15, // Stagger the start of each box
                motionPath: {
                    path: pathCoordinates,
                    // alignOrigin will make the box center follow the path
                    alignOrigin: [0.5, 0.5],
                    start: 0, // Start at the end of the path (off-screen)
                    end: 1    // Animate TO the start of the path (on-screen, 0,0)
                }
            });
            // tl.st.animation = slideInAnimation;
            // gsap.to(".marketing-section", {
            //     scrollTrigger: {
            //         trigger: ".marketing-section",
            //         start: `top ` + scrollSectionHeight, // after first section finished
            //         end: marketingSectionHeight.toString(), // scroll distance for overlap
            //         scrub: true,
            //         pinSpacing: false,
            //         pin: true // no pin here
            //     }
            // });
            // 2. **ATTACH SCROLLTRIGGER**
            let st= ScrollTrigger.create({
                trigger: ".marketing-section",
                start: "top "+document.querySelector('.marketing-section').getBoundingClientRect().top,
                end: "+=600",
                scrub: true,
                pin: true,
                animation: slideInAnimation,
                markers: false,
            });
            console.log(st);
        }

    });
</script>