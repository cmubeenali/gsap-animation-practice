<script>
    jQuery('body').ready(function () {
        gsap.registerPlugin(ScrollTrigger, MotionPathPlugin);

        let isMobile = window.matchMedia("(max-width: 768px)").matches;

        let scrollSectionHeight = document.querySelector(".scroll-section").offsetHeight;
        // console.log(scrollSectionHeight);
        let marketingSectionHeight = document.querySelector(".marketing-section").offsetHeight;
        // console.log(marketingSectionHeight);
        // alert(scrollSectionHeight.toString() + ' ' + marketingSectionHeight.toString() + ' ' + isMobile.toString());

        let scrollSectionPinTopValue = 'top';
        if (isMobile) {
            scrollSectionPinTopValue = `top-=${(document.querySelector(".scroll-section").getBoundingClientRect().top)}`;
            setTimeout(() => {
                // initAnimation();
                initAnimationMobile();
                ScrollTrigger.refresh();
            }, 0);
        } else {
            initAnimationWeb();
        }

        function initAnimationMobile() {
            ScrollTrigger.config({ viewport: "mobile" }); // Essential for mobile stability

            let tl = gsap.timeline({
                scrollTrigger: {
                    trigger: ".scroll-section",
                    start: "top top",
                    end: `${scrollSectionHeight}`,
                    scrub: true,
                    pin: true,
                    pinSpacing: false,
                    anticipatePin: 1,
                }
            });

            // 1. --- PHASE 1: Caption Animations (0.0s to 1.0s) ---
            // Start Caption 1 set at 0.0s. It will run until 0.5s.
            tl.to(".logo", { opacity: 0, ease: "power4.out" }, 0);
            tl.to(".text-caption-wrapper", { x: 10, width: "100%", ease: "power2.out" }, 0);
            tl.to(".text-caption-wrapper .text-caption", { x: 0, color: '#EC4D20', ease: "power3.out" }, 0.2);

            // Start Caption 2 set at 0.5s. It must finish by 1.0s.
            // NOTE: We don't use 'caption2Start' label anymore for simplicity.
            tl.to(".text-caption-wrapper-2", { x: 10, width: "100%", ease: "power2.out" }, 0.5);
            tl.to(".text-caption-wrapper-2 .text-caption-2", { x: 0, color: '#EC4D20', ease: "power3.out" }, 0.7);

            // ScrollTrigger.create({
            //     trigger:'.marketing-section',
            //     pin:true,
            //     pinSpacing:false,
            //     start:'top 100%'
            // });

            // Refresh listener (Keep this)
            ScrollTrigger.addEventListener("refresh", () => {
                // ... recalculate heights
            });
        }

        function initAnimationWeb() {
            gsap.to('.scroll-section', {
                scrollTrigger: {
                    trigger: ".scroll-section",
                    start: () => `${scrollSectionPinTopValue} top`,
                    end: (marketingSectionHeight + scrollSectionHeight).toString(),
                    scrub: true,
                    pin: true,
                    pinSpacing: false,
                    anticipatePin: 1
                }
            });

            const tl = gsap.timeline({
                scrollTrigger: {
                    trigger: ".scroll-section",
                    start: "0",
                    end: "450",
                    scrub: true,
                    pin: false,
                    pinSpacing: false,
                    anticipatePin: 1
                }
            });

            // Fade out logo
            tl.to(".logo", {
                opacity: 0,
                ease: "power4.out",
                duration: 0.2,
                // scrollTrigger: {
                //     trigger: ".logo-section",
                //     start: "top top",
                //     end: "100% top",
                //     scrub: true,
                //     pin: true,
                //     pinSpacing: false,
                //     anticipatePin: 0
                // }
            }, 0);

            // First wrapper animations
            tl.to(".text-caption-wrapper", {
                x: 10,
                duration: 0.5,
                ease: "power2.out"
            }, 0);

            tl.to(".text-caption-wrapper", {
                width: "100%",
                duration: 0.5,
                ease: "power2.inOut"
            }, 0);

            tl.to(".text-caption-wrapper .text-caption", {
                x: 0,
                duration: 0.1,
                color: '#EC4D20',
                ease: "power3.out",
            }, 0.2);

            // 🕒 Now the second set starts AFTER all above are complete
            tl.to(".text-caption-wrapper-2", {
                x: 10,
                duration: 0.5,
                ease: "power2.out"
            }, '>');

            tl.to(".text-caption-wrapper-2", {
                width: "100%",
                duration: 0.5,
                ease: "power2.inOut"
            }, '<');

            tl.to(".text-caption-wrapper-2 .text-caption-2", {
                x: 0,
                color: '#EC4D20',
                duration: 0.1,
                ease: "power3.out",
            }, '<0.2');

            // 2️⃣ Trigger for animation-section overlapping
            let boxes = gsap.utils.toArray('.marketing-box-1, .marketing-box-2, .marketing-box-3');
            // console.log(boxes);
            // Define path coordinates dynamically
            // Note: x:0, y:0 is now the FINAL destination
            const pathCoordinates = [
                { x: 0, y: 0 },
                { x: window.innerWidth / 2, y: window.innerHeight / 6 },
                { x: window.innerWidth + 100, y: window.innerHeight }
            ];
            // 1. **CRITICAL FIX: Use gsap.set() to override Elementor's initial transforms.**
            // This instantly moves all boxes to the desired final resting position (x:0, y:0)
            // and removes Elementor's initial transform offset.
            gsap.set(boxes, {
                x: 0, // Reset Elementor's horizontal transform
                y: 0, // Reset Elementor's vertical transform
                // We use the first coordinate of the path for the instant placement.
                // motionPath: {
                //     path: pathCoordinates,
                //     alignOrigin: [0.5, 0.5],
                //     start: 0, // Set to the final destination point (progress 0)
                // }
            });
            // 1. **Apply the animation to ALL boxes using stagger**
            const slideInAnimation = gsap.from(boxes, { // <-- Use .from()
                ease: "power2.out",
                stagger: 0.15, // Stagger the start of each box
                motionPath: {
                    path: pathCoordinates,
                    // alignOrigin will make the box center follow the path
                    alignOrigin: [0.5, 0.5],
                    start: 0, // Start at the end of the path (off-screen)
                    end: 1    // Animate TO the start of the path (on-screen, 0,0)
                }
            });
            gsap.to(".marketing-section", {
                scrollTrigger: {
                    trigger: ".marketing-section",
                    start: `${scrollSectionPinTopValue} ` + scrollSectionHeight, // after first section finished
                    end: marketingSectionHeight.toString(), // scroll distance for overlap
                    scrub: true,
                    pinSpacing: false,
                    pin: true // no pin here
                }
            });
            // 2. **ATTACH SCROLLTRIGGER**
            ScrollTrigger.create({
                trigger: ".marketing-section",
                start: "top top",
                end: "bottom top",
                scrub: true,
                pin: true,
                animation: slideInAnimation,
                markers: false,
            });
        }
    });

</script>